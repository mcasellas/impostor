<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Joc de l'Impostor</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1">
    </head>
    <body>
        <div class="px-5 py-5 my-5 text-center"> 
            <!-- <img class="d-block mx-auto mb-4" src="/docs/5.3/assets/brand/bootstrap-logo.svg" alt="" width="72" height="57">  -->
            <a href="/"><i class="bi bi-incognito" style="font-size: 6rem; color: cornflowerblue;"></i></a>
            <h1 class="display-5 fw-bold text-body-emphasis">El joc de l'impostor</h1> 
            <div class="col-lg-6 mx-auto"> 
                <p class="lead mb-4">Un jugador és l'impostor i no coneix la paraula secreta. La resta hauran de donar pistes sense ser massa evidents!</p> 
                <div class="row">
                    <div id="generar_partida" class="col-lg-6 mx-auto">
                        <div class="card border-success mb-4">
                            <div class="card-header bg-transparent border-success">
                                <h5>Inicia una nova partida</h5>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label for="players" class="mb-2">Número de jugadors</label>
                                    <input type="number" class="form-control text-center" id="players" aria-describedby="players" placeholder="3" min="3" max="9" value="3">
                                    <!-- <small id="emailHelp" class="form-text text-muted">We'll never share your email with anyone else.</small> -->
                                </div>
                            </div>
                            <div class="card-footer border-success">
                                <button type="submit" class="btn btn-success btn-lg px-4" onclick="generateSeed()">Generar partida</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mx-auto">
                        <form action="play.html" method="get">
                            <div class="card border-primary">
                                <div class="card-header bg-transparent border-primary">
                                    <h5>Uneix-te a una partida existent</h5>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label for="seed" class="mb-2">Llavor</label>
                                        <input type="text" class="form-control text-center" id="seed" name="seed" aria-describedby="seed" required>
                                        <!-- <small id="emailHelp" class="form-text text-muted">We'll never share your email with anyone else.</small> -->
                                    </div>
                                </div>
                                <div class="card-footer border-primary">
                                    <div class="row">
                                        <button type="submit" class="btn btn-primary btn-lg btn-block">Uneix-te a la partida</button>
                                        <button type="button" class="btn btn-success btn-lg btn-block mt-2" id="shareBtn" style="display: none;">Compartir enllaç</button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div id="seed_placeholder" class="mt-4" style="display: none;">
                    <h1><strong>Llavor: </strong></h1>
                    <p class="text-center" id="seed_show"></p>
                </div>
            </div> 
        </div>

        <script>
            let seedGenerat = null;
            let paraules = [];

            fetch('assets/json/paraules.json')
                .then(r => r.json())
                .then(data => paraules = data)
                .catch(err => console.error('Error carregant categories:', err));

            function xorEncrypt(str, key) {
                let result = '';
                for (let i = 0; i < str.length; i++) {
                    result += String.fromCharCode(str.charCodeAt(i) ^ key.charCodeAt(i % key.length));
                }
                return result;
            }

            function generateSeed() {
                const totalPlayers = parseInt(document.getElementById('players').value);
                if (!totalPlayers || totalPlayers < 3) {
                    alert('Cal indicar com a mínim 3 jugadors!');
                    return;
                }

                const rounds = 5;
                const impostorOrder = [];
                const categories = [];
                const words = [];

                for (let i = 0; i < rounds; i++) {
                    impostorOrder.push(Math.floor(Math.random() * totalPlayers) + 1);

                    let catIndex;
                    do {
                        catIndex = Math.floor(Math.random() * paraules.length);
                    } while (categories.includes(catIndex));
                    categories.push(catIndex);

                    let wordIndex = Math.floor(Math.random() * paraules[catIndex].words.length);
                    words.push(wordIndex);
                }

                const gameData = {
                    r: rounds,
                    p: totalPlayers,
                    i: impostorOrder,
                    c: categories,
                    w: words
                };

                // Codificar + ofuscar
                const jsonStr = JSON.stringify(gameData);
                const encrypted = xorEncrypt(jsonStr, "clauSecreta123");
                const base64 = btoa(encrypted);

                seedGenerat = base64;

                document.getElementById("seed_show").textContent = seedGenerat;
                document.getElementById("seed").value = seedGenerat;
                document.getElementById("shareBtn").style.display = "block";
                document.getElementById("generar_partida").style.display = "none";
            }

            document.getElementById("shareBtn").addEventListener("click", () => {
                                const url = `${window.location.origin}/play.html?seed=${seedGenerat}`;
                if (navigator.share) {
                    navigator.share({
                        title: 'Partida nova',
                        text: 'Uneix-te a la partida!',
                        url: url
                    });
                } else {
                    navigator.clipboard.writeText(url).then(() => {
                        alert("Enllaç copiat al porta-retalls!");
                    });
                }
            });
        </script>

    </body>
</html>
