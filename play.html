<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Joc de l'Impostor</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
    </head>
    <body>
        <div class="px-4 py-5 my-5 text-center"> 
            <!-- <img class="d-block mx-auto mb-4" src="/docs/5.3/assets/brand/bootstrap-logo.svg" alt="" width="72" height="57">  -->
            <a href="/"><i class="bi bi-incognito" style="font-size: 6rem; color: cornflowerblue;"></i></a>
            <h1 class="display-5 fw-bold text-body-emphasis">Som-hi!</h1>
            <p>Jugador: <span id="selected_player">X</span>/<span id="totalPlayers">X</span></p>
            <div class="col-lg-6 mx-auto" id="select_player">
                <!-- <p class="lead mb-4">Un jugador és l'impostor i no coneix la paraula secreta. La resta hauran de donar pistes sense ser massa evidents!</p>  -->
                <div class="form-group mb-4">
                    <label for="playerNumber" class="mb-2">Número del jugador</label>
                    <input type="number" class="form-control" id="playerNumber" min="1" required>
                    <small class="form-text text-muted">Poseu-vos d'acord entre vosaltres.</small>
                </div>
                <div class="d-grid gap-2 d-sm-flex justify-content-sm-center"> 
                    <button type="button" onclick="mostrarRondes()" class="btn btn-primary btn-lg px-4 gap-3">Assignar paraules</button>
                </div>

            </div> 
            <div class="col-lg-6 mx-auto">
                <div class="accordion mt-4" id="accordionExample"></div>
            </div>
        </div>

        <script>
            let paraules = [];
            let gameData = null;

            fetch('assets/json/paraules.json')
                .then(r => r.json())
                .then(data => {
                    paraules = data;
                    decodeSeed();
                });

            function xorDecrypt(str, key) {
                let result = '';
                for (let i = 0; i < str.length; i++) {
                    result += String.fromCharCode(str.charCodeAt(i) ^ key.charCodeAt(i % key.length));
                }
                return result;
            }

            function decodeSeed() {
                const params = new URLSearchParams(window.location.search);
                const seedFromUrl = params.get('seed');
                if (!seedFromUrl) return;

                try {
                    const decrypted = xorDecrypt(atob(seedFromUrl), "clauSecreta123");
                    gameData = JSON.parse(decrypted);
                    // console.log(gameData);

                    document.getElementById("totalPlayers").textContent = gameData.p;
                } catch (e) {
                    alert("Seed invàlida!");
                    console.error(e);
                }
            }

            function mostrarRondes() {
                const playerNum = parseInt(document.getElementById("playerNumber").value);
                if (!playerNum || playerNum < 1 || playerNum > gameData.p) {
                    alert("Número de jugador invàlid");
                    return;
                }   

                document.getElementById("selected_player").textContent = playerNum;
                document.getElementById("select_player").style.display = "none";

                const container = document.getElementById("accordionExample");
                container.innerHTML = '';

                gameData.i.forEach((impostor, index) => {
                    const ronda = index + 1;
                    const collapseId = `collapse${ronda}`;
                    const headingId = `heading${ronda}`;
                    const catIndex = gameData.c[index];

                    let bodyContent = "";

                    if (impostor === playerNum) {
                        bodyContent = `
                            <div class="row">
                                <div class="col-4">
                                    <i class="bi bi-incognito" style="font-size: 6rem; color: cornflowerblue;"></i>
                                </div>
                                <div class="col-8">
                                    <strong>Shhht! Dissimula!</strong> Ets l'infiltrat, has de passar desapercebut.
                                </div>
                            </div>
                        `;
                    } else {
                        const wordIndex = gameData.w[index];
                        bodyContent = `
                            <div class="row">
                                <div class="col-4">
                                    <i class="bi bi-lightbulb" style="font-size: 6rem; color: gold;"></i>
                                </div>
                                <div class="col-8">
                                    <p><strong>Paraula:</strong> ${paraules[catIndex].words[wordIndex]}</p>
                                </div>
                            </div>
                        `;
                    }

                    container.innerHTML += `
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="${headingId}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}">
                                    Ronda #${ronda} - ${paraules[catIndex].name}
                                </button>
                            </h2>
                            <div id="${collapseId}" class="accordion-collapse collapse" aria-labelledby="${headingId}" data-bs-parent="#accordionExample">
                                <div class="accordion-body">
                                    ${bodyContent}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            </script>
    </body>
</html>
